version: '3.1'
name: dna-node-processor

services:

###########################################################################
############################### RTSP-SERVER ###############################
###########################################################################
  rtsp-server:
    container_name: 'rtsp-server'
    image: aler9/rtsp-simple-server
    ports:
      - "8554:8554"
      - "1935:1935"
      - "8888:8888"
    environment:
      RTSP_PROTOCOLS: "tcp"

###########################################################################
########################### DNA_NODE_PROCESSOR ############################
###########################################################################
  dna-node-processor:
    container_name: 'dna-node-processor'
    image: kwlee0220/dna-node
    volumes:
      - .:/dna.node
    environment:
      DNA_NODE_CONF_ROOT: "conf"
      DNA_NODE_KAFKA_BROKERS: "kafka02:19092"
      DNA_NODE_RABBITMQ_HOST: "rabbitmq:5672"
      DNA_NODE_SYNC: "False"
      DNA_NODE_SHOW_PROGRESS: "True"
      DNA_NODE_FFMPEG_PATH: "/opt/conda/bin/ffmpeg"
      DISPLAY: "${DISPLAY}"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    command: dna_node_processor
    depends_on:
      - rtsp-server
    networks:
      - dna_server_net
    restart: no

networks:
  dna_server_net:
    external: true
    internal: true
