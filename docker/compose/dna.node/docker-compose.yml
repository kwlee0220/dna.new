version: '3.1'
name: dna-node

services:

###########################################################################
############################### RTSP-SERVER ###############################
###########################################################################
  rtsp-server:
    container_name: 'rtsp-server'
    image: aler9/rtsp-simple-server
    ports:
      - "8554:8554"
      - "1935:1935"
      - "8888:8888"
    environment:
      RTSP_PROTOCOLS: "tcp"

###########################################################################
################################ DNA_NODE #################################
###########################################################################
  dna-node:
    container_name: 'dna-node'
    image: kwlee0220/dna-node
    volumes:
      - ./data/dna.node:/dna.node
      - ./data/torch_hub:/root/.cache/torch/hub
    environment:
      # DNA_NODE_CAMERA: "rtsp://admin:dnabased24@129.254.82.33:558/LiveChannel/3/media.smp"
      DNA_NODE_SYNC: "True"
      DNA_NODE_SHOW: "True"
      DNA_NODE_FFMPEG_PATH: "/opt/conda/bin/ffmpeg"
      DNA_NODE_KAFKA_BROKERS: "kafka01:19091,kafka02:19092,kafka03:19093"
      # DISPLAY: "192.168.0.51:0.0"
      DISPLAY: "${DISPLAY}"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - dna_server_net
    command: dna_node --conf conf/dna.node.yaml
    depends_on:
      - rtsp-server
    restart: no

  # dna-node-processor:
  #   container_name: 'dna-node-processor'
  #   image: kwlee0220/dna-node
  #   volumes:
  #     - ./data/dna.node:/dna.node
  #     - ./data/torch_hub:/root/.cache/torch/hub
  #   environment:
  #     DNA_NODE_FFMPEG_PATH: "/opt/conda/bin/ffmpeg"
  #     DISPLAY: "${DISPLAY}"
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             count: 1
  #             capabilities: [gpu]
  #   command: dna_node_processor
  #   depends_on:
  #     - rtsp-server
  #   networks:
  #     - dna_server_net

networks:
  dna_server_net:
    external: true
    internal: true
